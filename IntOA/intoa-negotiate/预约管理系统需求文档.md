# 预约管理系统需求文档（修订版v2）

## 1. 引言

### 1.1 项目背景
随着组织管理需求的日益复杂化，预约管理系统成为提升资源利用效率、规范预约流程的重要工具。本系统旨在提供一个完整、高效的预约管理解决方案，通过合理的资源分配和状态管理机制，确保预约过程的顺畅和资源的有效利用。

### 1.2 系统目标
- 实现房间、茶水等资源的预约管理
- 提供完善的并发控制机制，防止资源冲突
- 建立清晰的预约状态流转机制
- 保证数据一致性和完整性
- 利用Redis缓存提升系统性能
- 提供友好的用户操作界面

## 2. 系统概述

### 2.1 核心业务实体

#### 2.1.1 预约记录(NegLog)
存储预约的完整信息，包括预约时间、房间、茶水、当事人信息等。

**主要字段：**
- logId: 预约记录主键
- logRoomName: 预约房间（快照）
- title: 预约标题
- logNickName: 用户昵称（快照）
- logTeaName: 预约茶水名称（快照）
- logTeaNum: 预约茶水数量（快照）
- clientName: 当事人姓名
- clientContact: 当事人联系方式
- caseReference: 相关案号/案由
- startTime: 预约开始时间
- endTime: 预约结束时间
- status: 预约状态

#### 2.1.2 茶水管理(NegTea)
管理茶水资源信息，包括名称、分类、库存等。

**主要字段：**
- teaId: 茶水主键
- teaName: 茶水名称
- category: 茶水分类
- stockQuantity: 库存数量
- status: 茶水状态（可用/缺货）

#### 2.1.3 房间管理(NegRoom)
管理房间资源信息，包括名称、位置、容量等。

**主要字段：**
- roomId: 房间主键
- roomName: 房间名称
- location: 位置
- capacity: 容纳人数
- equipment: 设备信息
- bufferTime: 缓冲时间
- status: 房间状态（可用/禁用）
- orderNum: 显示顺序

### 2.2 核心业务流程
```
选择房间/时间段 → 临时锁定资源 → 填写预约信息 → 提交预约 → 已确认(资源正式占用) → 已签到 → 已完成
                                                              ↘
                                                               → 已取消(资源释放)
```

## 3. 详细业务需求

### 3.1 预约生命周期管理

#### 3.1.1 预约状态定义
| 状态码 | 状态名称 | 说明 | 可见性 |
|--------|----------|------|--------|
| 0 | 待确认 | 用户选择资源后系统临时锁定，用户填写信息但未提交 | 仅当前用户可见 |
| 1 | 已确认 | 用户提交预约，资源正式占用 | 所有相关用户可见 |
| 2 | 已签到 | 用户实际到场签到 | 所有相关用户可见 |
| 3 | 已完成 | 预约正常结束 | 历史记录 |
| 4 | 已取消 | 预约被取消，资源释放 | 历史记录 |

#### 3.1.2 状态流转规则
```
选择资源 → 0(待确认)
0(待确认) → 1(已确认) [用户提交预约]
0(待确认) → 4(已取消) [超时自动取消/用户取消]
1(已确认) → 2(已签到) [用户签到]
1(已确认) → 4(已取消) [管理员取消/用户取消]
2(已签到) → 3(已完成) [预约时间结束/用户提前完成]
```

### 3.2 基于Redis的资源锁定机制

#### 3.2.1 房间资源锁定
**临时锁定（待确认状态）：**
- 用户选择房间和时间段时，系统立即在Redis中临时锁定指定房间和时间段
- 锁定信息仅对当前用户可见
- 设置锁定过期时间（如30分钟），过期自动释放

**正式锁定（已确认状态）：**
- 用户提交预约后，临时锁定转为正式锁定
- 锁定信息对所有相关用户可见
- 锁定持续到预约完成或取消

#### 3.2.2 茶水库存管理
**预占机制：**
- 待确认状态下预占茶水库存
- 已确认状态下正式扣减库存
- 已取消状态下返还预占库存

**库存合并：**
- 相同名称茶水自动合并库存
- 库存增减操作记录操作人和时间

### 3.3 Redis缓存设计

#### 3.3.1 Redis键值设计
```
# 房间锁定信息
Key: room:lock:{roomName}:{date}
Value: {startTime}-{endTime}:{reservationId}:{lockStatus}:{expireTime}

# 茶水库存信息
Key: tea:stock:{teaName}
Value: {stockQuantity}

# 预约状态信息
Key: reservation:status:{reservationId}
Value: {status}

# 临时锁定信息（用于超时处理）
Key: temp:lock:{userId}:{timestamp}
Value: {roomLockInfo}:{teaLockInfo}
```

#### 3.3.2 锁定状态定义
- `0`: 临时锁定（待确认状态）
- `1`: 正式锁定（已确认状态）

### 3.4 并发控制机制

#### 3.4.1 时间冲突检测
- 用户选择资源时检查房间时间冲突
- 时间重叠算法考虑缓冲时间避免紧密连接
- 同一房间同一时间段只能有一个有效预约

#### 3.4.2 资源锁定验证
- 待确认和已确认状态的预约都视为资源占用
- 用户选择资源时检查所有相关资源的占用情况
- 采用Redis原子操作确保并发安全性

### 3.5 核心功能需求

#### 3.5.1 房间和时间段选择
**功能描述：**
用户可以选择先选房间再选时间段，或者先选时间段再选房间

**业务规则：**
1. 如果用户先选择房间：
   - 系统显示该房间的详细信息（位置、容量、设备等）
   - 系统显示该房间在指定日期的可用时间段
   - 用户从可用时间段中选择预约时间

2. 如果用户先选择时间段：
   - 用户选择预约的开始和结束时间
   - 系统显示在该时间段内可用的房间列表
   - 用户从可用房间中选择预约房间

3. 选择完成后，系统在Redis中临时锁定选定的房间和时间段

**输入：**
- 选择方式（先选房间或先选时间段）
- 房间ID或时间段（开始时间、结束时间）
- 用户ID

**输出：**
- 房间详细信息（先选房间时）
- 可用时间段列表（先选房间时）
- 可用房间列表（先选时间段时）
- 临时锁定结果

#### 3.5.2 预约提交
**功能描述：**
用户填写完整预约信息并提交

**业务规则：**
1. 验证临时锁定资源是否仍然有效
2. 将Redis中的临时锁定转为正式锁定
3. 创建已确认状态的预约记录
4. 正式扣减茶水库存
5. 记录创建人和创建时间

**输入：**
- 预约房间名称
- 预约标题
- 预约茶水及数量
- 当事人信息
- 案号/案由
- 其他预约信息

**输出：**
- 预约记录ID
- 操作结果状态

#### 3.5.3 用户签到
**功能描述：**
用户实际到场进行签到操作

**业务规则：**
1. 验证预约当前状态为已确认
2. 验证当前时间在预约时间段内
3. 更新预约状态为已签到
4. 记录签到人和签到时间

**输入：**
- 预约记录ID
- 签到操作

**输出：**
- 操作结果状态

#### 3.5.4 预约完成
**功能描述：**
预约正常结束

**业务规则：**
1. 验证预约当前状态为已签到
2. 验证当前时间超过预约结束时间
3. 更新预约状态为已完成
4. 保留房间资源锁定信息（用于历史查询）
5. 记录完成人和完成时间

**输入：**
- 预约记录ID
- 完成操作

**输出：**
- 操作结果状态

#### 3.5.5 预约取消
**功能描述：**
取消预约并释放资源

**业务规则：**
1. 验证预约当前状态为待确认或已确认
2. 从Redis中删除房间资源锁定
3. 返还预占的茶水库存
4. 更新预约状态为已取消
5. 记录取消原因和取消时间

**输入：**
- 预约记录ID
- 取消原因

**输出：**
- 操作结果状态

#### 3.5.6 超时处理
**功能描述：**
自动处理超时未确认的预约

**业务规则：**
1. 在预约相关操作中检查临时锁定是否过期
2. 超过30分钟的临时锁定自动释放
3. 释放相关资源锁定
4. 更新预约状态为已取消

### 3.6 数据管理需求

#### 3.6.1 房间管理
**功能描述：**
维护房间资源信息

**业务规则：**
1. 支持房间信息的增删改查
2. 房间状态控制（可用/禁用）
3. 房间详情展示（位置、容量、设备等）
4. 操作记录操作人和操作时间

**核心功能：**
- 房间信息查询
- 房间信息新增/修改
- 房间信息删除
- 房间状态管理

#### 3.6.2 茶水管理
**功能描述：**
维护茶水资源信息

**业务规则：**
1. 支持茶水信息的增删改查
2. 相同名称茶水自动合并库存
3. 茶水状态同步更新到数据字典
4. 操作记录操作人和操作时间

**核心功能：**
- 茶水信息查询
- 茶水信息新增/修改
- 茶水信息删除
- 库存数量管理

#### 3.6.3 预约查询
**功能描述：**
查询预约记录信息

**业务规则：**
1. 支持多条件组合查询
2. 根据用户角色控制数据可见性
3. 自动更新过期预约状态
4. 支持导出功能

**查询条件：**
- 预约时间段
- 房间名称
- 预约状态
- 当事人姓名
- 创建人

## 4. 非功能性需求

### 4.1 性能需求
- 系统响应时间不超过3秒
- 支持并发用户数不少于100
- 数据库查询响应时间不超过1秒
- Redis操作响应时间不超过100毫秒

### 4.2 可用性需求
- 系统可用性不低于99.5%
- 支持7×24小时运行
- 提供友好的用户界面

### 4.3 安全性需求
- 用户权限控制
- 数据访问控制
- 操作日志记录
- 敏感信息加密存储

### 4.4 可维护性需求
- 模块化设计，便于功能扩展
- 完善的错误处理机制
- 详细的日志记录
- 清晰的代码结构和注释

## 5. 系统架构设计

### 5.1 技术架构
- 后端框架：Spring Boot + MyBatis
- 数据库：MySQL
- 缓存：Redis（用于资源锁定和库存管理）
- 安全框架：Spring Security

### 5.2 数据架构
#### 5.2.1 核心数据表
1. **预约记录表(oa_neg_log)**
2. **茶水信息表(oa_neg_tea)**
3. **房间信息表(oa_neg_room)**

#### 5.2.2 Redis缓存结构
1. **房间锁定缓存**：存储房间资源锁定信息
2. **茶水库存缓存**：存储茶水库存信息
3. **预约状态缓存**：存储预约状态信息
4. **临时锁定缓存**：存储用户临时锁定信息，用于超时处理

#### 5.2.3 索引设计
- 预约表：房间+时间、状态等关键字段索引
- 茶水表：名称、状态等关键字段索引
- 房间表：状态等关键字段索引

## 6. 部署和运维需求

### 6.1 部署环境
- 操作系统：Linux/Windows Server
- 应用服务器：Tomcat/Jetty
- 数据库：MySQL 8.2.0
- 缓存：Redis 3.0+

### 6.2 监控需求
- 系统性能监控
- 数据库性能监控
- Redis性能监控
- 错误日志监控

## 7. Redis缓存实现方案详解

### 7.1 房间资源锁定实现
使用Redis Hash数据结构存储房间锁定信息：
```
Key: room:locks:{roomName}
Field: {startTime}:{endTime}
Value: {reservationId}:{lockStatus}:{expireTime}
```

### 7.2 茶水库存管理实现
使用Redis String数据结构存储茶水库存：
```
Key: tea:stock:{teaName}
Value: {stockQuantity}
```

### 7.3 并发控制实现
通过Redis原子操作保证并发安全性：
1. 使用Lua脚本实现复杂的原子操作
2. 利用Redis事务保证操作一致性
3. 使用分布式锁防止并发冲突

### 7.4 超时处理实现
将超时处理逻辑集成到业务流程中：
1. 在用户选择资源时检查并清理过期的临时锁定
2. 在用户提交预约时检查临时锁定是否过期
3. 在预约取消时清理相关锁定信息

## 8. 房间与时间段选择交互设计

### 8.1 先选房间后选时间段流程
```
用户选择房间
    ↓
系统显示房间详情
    ↓
系统查询并显示该房间在指定日期的可用时间段
    ↓
用户选择时间段
    ↓
系统临时锁定房间和时间段
```

### 8.2 先选时间段后选房间流程
```
用户选择时间段（开始时间、结束时间）
    ↓
系统查询并显示在该时间段内可用的房间列表
    ↓
用户选择房间
    ↓
系统临时锁定房间和时间段
```

### 8.3 房间详情展示
房间详情包括：
- 房间名称
- 位置信息
- 容纳人数
- 设备信息
- 缓冲时间
- 当前状态

## 9. 风险评估与应对

### 9.1 主要风险
1. **Redis故障风险**：Redis服务不可用导致系统异常
2. **并发冲突风险**：高并发场景下的资源竞争
3. **数据一致性风险**：Redis与数据库数据不一致
4. **性能瓶颈风险**：大量预约记录的查询性能

### 9.2 应对措施
1. 实现Redis故障降级机制，故障时使用数据库直接操作
2. 采用Redis原子操作和分布式锁相结合的并发控制机制
3. 通过业务逻辑同步Redis与数据库数据
4. 引入缓存机制提升查询性能
5. 定期进行性能优化和数据库维护

## 10. 附录

### 10.1 术语表
- **快照**：预约创建时资源信息的副本，确保历史记录的准确性
- **临时锁定**：用户选择资源后系统预锁定机制
- **正式锁定**：用户提交预约后资源正式占用机制
- **预占库存**：用户选择资源后对茶水库存的临时占用

### 10.2 参考资料
- 系统现有代码结构
- 业务需求分析文档
- 相关技术规范文档
- Redis官方文档